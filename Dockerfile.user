ARG version
FROM tschaffter/debian:base-${version}

ARG user
RUN test -n "${user}"

# Install the tools that I need in all my environments
# hadolint ignore=DL3008
RUN apt-get update -qq -y && apt-get install --no-install-recommends -qq -y \
    bash-completion \
    curl \
    git \
    gnupg2 \
    htop \
    openssh-client \
    sudo \
    tmux \
    vim \
    && apt-get -y autoclean \
    && apt-get -y autoremove \
    && rm -rf /var/lib/apt/lists/*

# Enable shell pipefail option
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Create user and set work directory
RUN useradd -m ${user} \
    && usermod -a -G sudo ${user} \
    && echo "${user} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${user} \
	&& chmod 0440 /etc/sudoers.d/${user}
USER ${user}
WORKDIR /home/${user}

# Create initial files to store in the persistent volume
RUN mkdir -p persist/dev && ln -s persist/dev . \
    && mkdir -p persist/.gnupg && ln -s persist/.gnupg . \
    && mkdir -p persist/.ssh && ln -s persist/.ssh . \
    && mkdir -p persist/.vim && ln -s persist/.vim . \
    && touch persist/.gitconfig && ln -s persist/.gitconfig . \
    && touch persist/.vimrc && ln -s persist/.vimrc . \
    && mv .profile persist/.profile && ln -s persist/.profile .

# Let GPG know which terminal it is running on.
RUN printf "\n# Let GPG know which terminal it is running on.\n\
GPG_TTY=\$(tty)\n\
export GPG_TTY\n" | tee -a ~/.bashrc

# Install vim color scheme
# hadolint ignore=DL3003
RUN cd .vim \
    && git clone https://github.com/tomasiser/vim-code-dark.git . \
    && rm -fr LICENSE.md README.md \
    && cd .. || exit \
    && printf "%s\n" \
        "set t_Co=256" \
        "set t_ut=" \
        "colorscheme codedark" \
        ":syntax on" | tee -a ~/.vimrc >/dev/null
